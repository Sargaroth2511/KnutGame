<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnutGame Developer Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            text-align: center;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .section h3 {
            color: #34495e;
            margin: 25px 0 15px 0;
            font-size: 1.4em;
        }

        .section h4 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 1.2em;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .method-signature {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .config-list {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .config-list ul {
            list-style: none;
            padding: 0;
        }

        .config-list li {
            padding: 5px 0;
            border-bottom: 1px solid #bdc3c7;
        }

        .config-list li:last-child {
            border-bottom: none;
        }

        .performance-card {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .compatibility-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .compatibility-item {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .compatibility-item strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 30px;
            font-size: 0.9em;
        }

        .api-docs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .api-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .api-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .api-link {
            display: inline-block;
            text-decoration: none;
            color: inherit;
            margin-top: 15px;
        }

        .api-link-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .api-link-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .module-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .module-links a {
            display: inline-block;
            padding: 6px 12px;
            background: #ecf0f1;
            color: #2c3e50;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }

        .module-links a:hover {
            background: #3498db;
            color: white;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 4px 0;
            position: relative;
            padding-left: 20px;
        }

        .feature-list li:before {
            content: "✓";
            color: #27ae60;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .architecture-diagram {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KnutGame Developer Documentation</h1>
            <p>Comprehensive guide for the TypeScript Phaser.js game application</p>
        </div>

        <div class="content">
            <div class="section">
                <h2>Overview</h2>
                <p>This document provides comprehensive documentation for the KnutGame TypeScript Phaser.js application. The codebase has been systematically refactored to follow SOLID principles, with comprehensive JSDoc documentation added to all major system files.</p>
            </div>

            <div class="section">
                <h2>Architecture Overview</h2>
                <p>The game is built using Phaser.js with a modular architecture consisting of several key systems:</p>

                <div class="architecture-diagram">KnutGame.Client/
├── systems/           # Core game systems
│   ├── ApiService     # Server communication
│   ├── LocalHighscoreService  # Local storage management
│   ├── BackgroundRenderer     # Procedural background generation
│   ├── CollisionDetector      # Advanced collision detection
│   ├── InputController        # Multi-device input handling
│   ├── PhysicsTimeline        # Physics-based animations
│   └── ParticlePool          # Object pooling for particles
├── services/          # Business logic services
├── ui/               # User interface components
└── assets/           # Game assets</div>
            </div>

            <div class="section">
                <h2>Core Systems Documentation</h2>

                <h3>ApiService</h3>
                <p><strong>Location:</strong> <code>src/systems/ApiService.ts</code></p>
                <p>Handles all server communication for session management and game data synchronization.</p>

                <h4>Key Methods</h4>
                <div class="method-signature">class ApiService {
  constructor(baseUrl: string)
  startSession(): Promise&lt;SessionResponse&gt;
  submitSession(sessionData: SessionData): Promise&lt;SubmitResponse&gt;
  getHighscores(): Promise&lt;HighscoreResponse&gt;
}</div>

                <h4>Usage Example</h4>
                <div class="code-block">const apiService = new ApiService('https://api.k Knutgame.com');
const session = await apiService.startSession();
// ... game logic ...
await apiService.submitSession(sessionData);</div>

                <h3>LocalHighscoreService</h3>
                <p><strong>Location:</strong> <code>src/systems/LocalHighscoreService.ts</code></p>
                <p>Manages high score persistence using localStorage with fallback handling.</p>

                <div class="method-signature">class LocalHighscoreService {
  constructor(storage?: KeyValueStorage)
  getHighscore(): number
  setHighscore(score: number): void
  clearHighscore(): void
}</div>

                <h3>BackgroundRenderer</h3>
                <p><strong>Location:</strong> <code>src/systems/BackgroundRenderer.ts</code></p>
                <p>Generates procedural skyscraper backgrounds with customizable parameters.</p>

                <div class="method-signature">class BackgroundRenderer {
  constructor(scene: Phaser.Scene, config: BackgroundConfig)
  render(): void
  updateConfig(newConfig: Partial&lt;BackgroundConfig&gt;): void
}</div>

                <div class="config-list">
                    <p><strong>Configuration Options</strong></p>
                    <p>The <code>BackgroundConfig</code> interface supports 23+ configuration properties including:</p>
                    <ul>
                        <li>Building dimensions and spacing</li>
                        <li>Window patterns and colors</li>
                        <li>Street level details</li>
                        <li>Color schemes and gradients</li>
                    </ul>
                </div>

                <h3>CollisionDetector</h3>
                <p><strong>Location:</strong> <code>src/systems/CollisionDetector.ts</code></p>
                <p>Advanced collision detection using Oriented Bounding Box (OBB) and Separating Axis Theorem (SAT) algorithms.</p>

                <div class="method-signature">class CollisionDetector {
  checkObstacleCollision(player: Player, obstacles: Obstacle[]): CollisionResult
  checkItemCollisions(player: Player, items: Item[]): ItemCollision[]
  checkGroundCollision(entity: Entity): GroundCollisionResult
}</div>

                <h3>InputController</h3>
                <p><strong>Location:</strong> <code>src/systems/InputController.ts</code></p>
                <p>Event-driven input system supporting keyboard and touch devices with responsive controls.</p>

                <div class="method-signature">class InputController {
  constructor(scene: Phaser.Scene)
  attach(): void
  detach(): void
  on(event: InputEvent, callback: Function): void
}</div>

                <h3>PhysicsTimeline</h3>
                <p><strong>Location:</strong> <code>src/systems/PhysicsTimeline.ts</code></p>
                <p>Physics-based animation and timing utilities for realistic game physics.</p>

                <div class="method-signature">class PhysicsTimeline {
  calculateToppleTimeline(entity: Entity): TimelineData
  shouldDespawnGroundItem(item: Item): boolean
  calculateFallDistance(height: number): number
}</div>

                <h3>SessionEventsBuffer</h3>
                <p><strong>Location:</strong> <code>src/systems/SessionEventsBuffer.ts</code></p>
                <p>Advanced session events buffer with performance optimization and memory management for gameplay analytics.</p>

                <div class="method-signature">class SessionEventsBuffer {
  constructor(config?: Partial&lt;SessionEventsBufferConfig&gt;)
  reset(): void
  snapshot(): SessionEvents
  pushMove(tMs: number, x: number): EventAdditionResult
  pushHit(tMs: number): EventAdditionResult
  pushItem(tMs: number, id: string, type: ItemType, x: number, y: number): EventAdditionResult
  queryEvents(options: EventQueryOptions): SessionEvents
  getStats(): BufferStats
  forceCleanup(): { totalRemoved: number; typesCleaned: string[] }
}</div>

                <h4>Usage Example</h4>
                <div class="code-block">const buffer = new SessionEventsBuffer({
  maxEventsPerType: 5000,
  enableAutoCleanup: true,
  enableValidation: true
});

// Add events
buffer.pushMove(1000, 150); // Player moved at t=1000ms, x=150
buffer.pushHit(1500); // Hit occurred at t=1500ms
buffer.pushItem(2000, 'item_123', ItemType.GIFT, 100, 200);

// Query events from last 5 seconds
const recentEvents = buffer.queryEvents({
  startTime: Date.now() - 5000,
  limit: 100,
  sortByTime: true
});

// Get buffer statistics
const stats = buffer.getStats();
console.log(`Total events: ${stats.totalEvents}`);
console.log(`Memory usage: ${stats.estimatedMemoryUsage} bytes`);</div>

                <div class="config-list">
                    <p><strong>Configuration Options</strong></p>
                    <ul>
                        <li><code>maxEventsPerType</code>: Maximum events per buffer type (default: 10000)</li>
                        <li><code>enableAutoCleanup</code>: Automatic cleanup when limits exceeded (default: true)</li>
                        <li><code>roundTimestamps</code>: Round timestamps to milliseconds (default: true)</li>
                        <li><code>enableValidation</code>: Validate event data before adding (default: true)</li>
                    </ul>
                </div>

                <h4>Performance Features</h4>
                <ul>
                    <li>Automatic memory management with configurable limits</li>
                    <li>Efficient event querying with time-based filtering</li>
                    <li>Memory usage estimation and statistics</li>
                    <li>Optional data validation for data integrity</li>
                    <li>Configurable cleanup policies</li>
                </ul>
            </div>

            <div class="section">
                <h2 id="toppledmanager">ToppledManager</h2>
                <p><strong>Location:</strong> <code>src/systems/ToppledManager.ts</code></p>
                <p>Manages the physics and animation of obstacles that have been toppled by the player. Handles the complete lifecycle from impact through toppling animation to eventual despawn, including collision blocking and visual effects.</p>

                <h3>Key Methods</h3>
                <pre><code class="language-typescript">class ToppledManager {
  constructor(config: ToppledManagerConfig)
  constructor(scene: Phaser.Scene, animGroup: Phaser.GameObjects.Group, blockGroup?: Phaser.GameObjects.Group, groundY?: number) // deprecated
  addFromFalling(obstacle: Phaser.GameObjects.Sprite, playerX: number): void
  update(deltaMs: number): void
  clear(): void
}</code></pre>

                <h3>Animation Phases</h3>
                <ol>
                    <li><strong>Impact Phase</strong>: Initial knockback and spin when obstacle is hit</li>
                    <li><strong>Falling Phase</strong>: Physics-based falling with gravity and air resistance</li>
                    <li><strong>Toppling Phase</strong>: Smooth rotation and sliding animation using easing</li>
                    <li><strong>Settled Phase</strong>: Collision blocking and despawn timing</li>
                </ol>

                <h3>Usage Example</h3>
                <pre><code class="language-typescript">// Using configuration object (recommended)
const manager = new ToppledManager({
  scene: this,
  animGroup: this.toppledAnimGroup,
  blockGroup: this.collisionGroup,
  groundY: 400
});

// Legacy constructor (deprecated)
const manager = new ToppledManager(scene, animGroup, blockGroup, groundY);

// Add a toppled obstacle
manager.addFromFalling(obstacleSprite, player.x);

// Update animations each frame
manager.update(game.loop.delta);</code></pre>

                <h3>Configuration Options</h3>
                <ul>
                    <li><strong><code>scene</code></strong>: The Phaser scene this manager belongs to</li>
                    <li><strong><code>animGroup</code></strong>: Group for animation sprites during toppling</li>
                    <li><strong><code>blockGroup</code></strong>: Group for collision-blocking sprites (optional, defaults to animGroup)</li>
                    <li><strong><code>groundY</code></strong>: Y position of the ground for collision detection (optional)</li>
                </ul>

                <h3>Key Features</h3>
                <ul>
                    <li>Multi-phase animation system with physics-based transitions</li>
                    <li>Directional toppling based on player position relative to obstacle</li>
                    <li>Automatic capacity management with oldest entry eviction</li>
                    <li>Collision blocking during animation to prevent unfair re-hits</li>
                    <li>Smooth cubic ease-out animations for natural movement</li>
                    <li>Memory-efficient with configurable maximum active entries</li>
                    <li>Comprehensive error handling for optional operations</li>
                </ul>
            </div>

            <div class="section">
                <h2>Configuration</h2>

                <h3>Game Configuration</h3>
                <p><strong>Location:</strong> <code>src/gameConfig.ts</code></p>
                <p>Central configuration file containing:</p>
                <ul>
                    <li>Game dimensions and scaling</li>
                    <li>Physics constants</li>
                    <li>Asset paths</li>
                    <li>Performance limits</li>
                </ul>

                <h3>TypeScript Configuration</h3>
                <p><strong>Location:</strong> <code>tsconfig.json</code></p>
                <p>TypeScript compiler options optimized for Phaser.js development:</p>
                <ul>
                    <li>Strict type checking enabled</li>
                    <li>ES2020 target</li>
                    <li>Module resolution for Phaser</li>
                </ul>
            </div>

            <div class="section">
                <h2>Development Workflow</h2>

                <h3>Building the Project</h3>
                <div class="code-block"># Development build with watch mode
npm run build:watch

# Production build
npm run build

# Type checking only
npm run type-check</div>

                <h3>Testing</h3>
                <div class="code-block"># Run all tests
npm test

# Run specific test file
npm test -- collisionToppled.spec.ts

# Run tests in watch mode
npm run test:watch</div>
            </div>

            <div class="section">
                <h2>Code Quality</h2>
                <p>The codebase follows these principles:</p>
                <ul>
                    <li><strong>SOLID Principles:</strong> Single responsibility, Open-closed, Liskov substitution, Interface segregation, Dependency inversion</li>
                    <li><strong>Comprehensive JSDoc:</strong> All public APIs documented</li>
                    <li><strong>Type Safety:</strong> Full TypeScript coverage</li>
                    <li><strong>Error Handling:</strong> Graceful degradation and logging</li>
                    <li><strong>Performance:</strong> Object pooling and efficient algorithms</li>
                </ul>
            </div>

            <div class="section">
                <h2>Performance Considerations</h2>

                <div class="performance-card">
                    <h4>Object Pooling</h4>
                    <ul>
                        <li>Particle effects use object pooling to prevent GC pressure</li>
                        <li>Maximum particle limit: Configurable via <code>MAX_PARTICLES</code></li>
                        <li>Automatic cleanup on scene destruction</li>
                    </ul>
                </div>

                <h4>Memory Management</h4>
                <ul>
                    <li>Event listeners properly cleaned up</li>
                    <li>Tween animations disposed correctly</li>
                    <li>Texture atlases optimized for mobile</li>
                </ul>

                <h4>Rendering Optimization</h4>
                <ul>
                    <li>Background rendering uses efficient batching</li>
                    <li>Collision detection optimized with spatial partitioning</li>
                    <li>Input handling uses event-driven architecture</li>
                </ul>
            </div>

            <div class="section">
                <h2>Browser Compatibility</h2>
                <div class="compatibility-grid">
                    <div class="compatibility-item">
                        <strong>Desktop</strong>
                        Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
                    </div>
                    <div class="compatibility-item">
                        <strong>Mobile</strong>
                        iOS Safari 14+, Chrome Mobile 90+
                    </div>
                    <div class="compatibility-item">
                        <strong>Performance</strong>
                        60 FPS target on modern devices
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>API Reference</h2>
                <p>Complete API documentation generated from JSDoc comments using TypeDoc.</p>

                <div class="api-docs-grid">
                    <div class="api-section">
                        <h4>📚 Complete API Documentation</h4>
                        <p>Interactive API reference with detailed documentation for all classes, interfaces, functions, and types.</p>
                        <a href="/api-docs/index.html" class="api-link" target="_blank">
                            <div class="api-link-content">
                                <span>View Full API Documentation</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15,3 21,3 21,9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </div>
                        </a>
                    </div>

                    <div class="api-section">
                        <h4>🔍 Key Modules</h4>
                        <div class="module-links">
                            <a href="/api-docs/modules/systems_SessionEventsBuffer.html">SessionEventsBuffer</a>
                            <a href="/api-docs/modules/systems_scoring.html">Scoring Service</a>
                            <a href="/api-docs/modules/systems_ParticlePool.html">ParticlePool</a>
                            <a href="/api-docs/modules/systems_CollisionSystem.html">CollisionSystem</a>
                            <a href="/api-docs/modules/services_api.html">API Service</a>
                            <a href="/api-docs/modules/MainScene.html">MainScene</a>
                        </div>
                    </div>

                    <div class="api-section">
                        <h4>📋 Documentation Features</h4>
                        <ul class="feature-list">
                            <li>Interactive search and navigation</li>
                            <li>Detailed parameter descriptions</li>
                            <li>Return type information</li>
                            <li>Inheritance hierarchies</li>
                            <li>Cross-references between modules</li>
                            <li>Responsive design for all devices</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>*This documentation is automatically generated from JSDoc comments in the source code. Last updated: September 10, 2025*</p>
        </div>
    </div>
</body>
</html>
